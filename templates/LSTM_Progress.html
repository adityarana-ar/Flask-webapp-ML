{% extends "base.html" %}

{% block title %}LSTM Processing · {{ ticker }} · Aditya Rana{% endblock %}

{% block content %}
<div class="space-y-6">
  <!-- Header Section -->
  <div class="text-center space-y-4">
    <h1 class="text-3xl font-bold text-gray-900 dark:text-white">LSTM Model Processing</h1>
    <p class="text-lg text-gray-600 dark:text-gray-300">Training LSTM model for {{ ticker }}</p>
  </div>

  <!-- Progress Section -->
  <div class="rounded-xl border border-gray-200 bg-white p-8 shadow-sm dark:border-gray-800 dark:bg-gray-900">
    <div class="text-center space-y-6">
      <!-- Spinner -->
      <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-indigo-600 mx-auto" id="spinner"></div>
      
      <!-- Status -->
      <div>
        <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-2" id="statusTitle">
          Initializing...
        </h2>
        <p class="text-sm text-gray-600 dark:text-gray-300" id="statusMessage">
          Starting LSTM model training process...
        </p>
      </div>
      
      <!-- Progress Bar -->
      <div class="w-full max-w-md mx-auto">
        <div class="flex justify-between text-sm text-gray-600 dark:text-gray-400 mb-2">
          <span>Progress</span>
          <span id="progressPercent">0%</span>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-3 dark:bg-gray-700">
          <div class="bg-indigo-600 h-3 rounded-full transition-all duration-500 ease-out" id="progressBar" style="width: 0%"></div>
        </div>
      </div>
      
      <!-- Estimated Time -->
      <div class="text-sm text-gray-500 dark:text-gray-400">
        <p>Estimated time: <span id="estimatedTime">2-5 minutes</span></p>
        <p>Please don't close this page or refresh the browser.</p>
      </div>
      
      <!-- Error Display -->
      <div id="errorDisplay" class="hidden">
        <div class="rounded-md border border-red-500/30 bg-red-500/10 px-4 py-3 text-sm text-red-700 dark:text-red-300">
          <p id="errorMessage"></p>
          <button onclick="window.location.href='/LSTM'" class="mt-2 text-red-600 hover:text-red-500 underline">
            ← Back to LSTM Form
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Steps Overview -->
  <div class="rounded-xl border border-gray-200 bg-white p-6 shadow-sm dark:border-gray-800 dark:bg-gray-900">
    <h2 class="text-xl font-semibold mb-4">Processing Steps</h2>
    <div class="space-y-3">
      <div class="flex items-center space-x-3" data-step="1">
        <div class="w-6 h-6 rounded-full border-2 border-gray-300 flex items-center justify-center text-xs step-indicator">1</div>
        <span class="text-sm text-gray-600 dark:text-gray-300">Download stock data</span>
      </div>
      <div class="flex items-center space-x-3" data-step="2">
        <div class="w-6 h-6 rounded-full border-2 border-gray-300 flex items-center justify-center text-xs step-indicator">2</div>
        <span class="text-sm text-gray-600 dark:text-gray-300">Preprocess data</span>
      </div>
      <div class="flex items-center space-x-3" data-step="3">
        <div class="w-6 h-6 rounded-full border-2 border-gray-300 flex items-center justify-center text-xs step-indicator">3</div>
        <span class="text-sm text-gray-600 dark:text-gray-300">Prepare model data</span>
      </div>
      <div class="flex items-center space-x-3" data-step="4">
        <div class="w-6 h-6 rounded-full border-2 border-gray-300 flex items-center justify-center text-xs step-indicator">4</div>
        <span class="text-sm text-gray-600 dark:text-gray-300">Build LSTM model</span>
      </div>
      <div class="flex items-center space-x-3" data-step="5">
        <div class="w-6 h-6 rounded-full border-2 border-gray-300 flex items-center justify-center text-xs step-indicator">5</div>
        <span class="text-sm text-gray-600 dark:text-gray-300">Train model (2-3 min)</span>
      </div>
      <div class="flex items-center space-x-3" data-step="6">
        <div class="w-6 h-6 rounded-full border-2 border-gray-300 flex items-center justify-center text-xs step-indicator">6</div>
        <span class="text-sm text-gray-600 dark:text-gray-300">Generate predictions</span>
      </div>
      <div class="flex items-center space-x-3" data-step="7">
        <div class="w-6 h-6 rounded-full border-2 border-gray-300 flex items-center justify-center text-xs step-indicator">7</div>
        <span class="text-sm text-gray-600 dark:text-gray-300">Create visualizations</span>
      </div>
      <div class="flex items-center space-x-3" data-step="8">
        <div class="w-6 h-6 rounded-full border-2 border-gray-300 flex items-center justify-center text-xs step-indicator">8</div>
        <span class="text-sm text-gray-600 dark:text-gray-300">Finalize results</span>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Simple polling approach for LSTM progress
let pollInterval;
let isCompleted = false;

const statusTitle = document.getElementById('statusTitle');
const statusMessage = document.getElementById('statusMessage');
const progressBar = document.getElementById('progressBar');
const progressPercent = document.getElementById('progressPercent');
const errorDisplay = document.getElementById('errorDisplay');
const errorMessage = document.getElementById('errorMessage');
const stepIndicators = document.querySelectorAll('.step-indicator');

function updateProgress(data) {
  if (data.step === 'error') {
    // Only show error if it's a real server-side error (not connection issues)
    if (data.message && !data.message.includes('Connection lost')) {
      statusTitle.textContent = 'Error Occurred';
      statusTitle.className = 'text-xl font-semibold text-red-600 dark:text-red-400 mb-2';
      errorMessage.textContent = data.message;
      errorDisplay.classList.remove('hidden');
      clearInterval(pollInterval);
    }
    return;
  }
  
  if (data.step === 'complete') {
    // Handle completion
    statusTitle.textContent = 'Processing Complete!';
    statusTitle.className = 'text-xl font-semibold text-green-600 dark:text-green-400 mb-2';
    statusMessage.textContent = data.message;
    progressBar.style.width = '100%';
    progressPercent.textContent = '100%';
    
    // Update all step indicators to completed
    stepIndicators.forEach(indicator => {
      indicator.className = 'w-6 h-6 rounded-full bg-green-500 border-2 border-green-500 flex items-center justify-center text-xs text-white';
      indicator.textContent = '✓';
    });
    
    // Stop polling
    clearInterval(pollInterval);
    isCompleted = true;
    
    // Redirect after a short delay
    setTimeout(() => {
      window.location.href = data.redirect;
    }, 2000);
    
    return;
  }
  
  // Update progress
  statusMessage.textContent = data.message;
  progressBar.style.width = data.progress + '%';
  progressPercent.textContent = data.progress + '%';
  
  // Update step indicators
  stepIndicators.forEach((indicator, index) => {
    const stepNumber = index + 1;
    if (stepNumber <= data.step) {
      // Completed step
      indicator.className = 'w-6 h-6 rounded-full bg-green-500 border-2 border-green-500 flex items-center justify-center text-xs text-white';
      indicator.textContent = '✓';
    } else if (stepNumber === data.step + 1) {
      // Current step
      indicator.className = 'w-6 h-6 rounded-full bg-indigo-500 border-2 border-indigo-500 flex items-center justify-center text-xs text-white';
      indicator.textContent = stepNumber;
    } else {
      // Pending step
      indicator.className = 'w-6 h-6 rounded-full border-2 border-gray-300 flex items-center justify-center text-xs text-gray-400';
      indicator.textContent = stepNumber;
    }
  });
}

function pollProgress() {
  fetch('/LSTM/stream/{{ ticker }}')
    .then(response => {
      if (!response.ok) {
        throw new Error('Network response was not ok');
      }
      return response.text();
    })
    .then(text => {
      // Parse SSE data
      const lines = text.split('\n');
      let hasValidData = false;
      
      for (const line of lines) {
        if (line.startsWith('data: ')) {
          try {
            const data = JSON.parse(line.substring(6));
            hasValidData = true;
            updateProgress(data);
            if (data.step === 'complete' || data.step === 'error') {
              break;
            }
          } catch (e) {
            console.error('Error parsing SSE data:', e);
          }
        }
      }
      
      // If we got valid data, reset any connection error messages
      if (hasValidData) {
        statusTitle.textContent = 'Processing LSTM Prediction...';
        statusTitle.className = 'text-xl font-semibold text-indigo-600 dark:text-indigo-400 mb-2';
        errorDisplay.classList.add('hidden');
      }
    })
    .catch(error => {
      console.error('Error polling progress:', error);
      if (!isCompleted) {
        // Only show connection message, don't trigger error display
        statusMessage.textContent = 'Connection lost, but processing continues on the server...';
        // Keep the title as processing, not error
        statusTitle.textContent = 'Processing LSTM Prediction...';
        statusTitle.className = 'text-xl font-semibold text-indigo-600 dark:text-indigo-400 mb-2';
        errorDisplay.classList.add('hidden');
      }
    });
}

// Start polling every 3 seconds (more resilient for long-running processes)
pollInterval = setInterval(pollProgress, 3000);

// Initial poll
pollProgress();

// Prevent page refresh/close during processing
window.addEventListener('beforeunload', function(e) {
  if (!isCompleted) {
    e.preventDefault();
    e.returnValue = 'Processing is in progress. Are you sure you want to leave?';
  }
});
</script>
{% endblock %}
