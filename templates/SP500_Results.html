{% extends "base.html" %}
{% block title %}S&P 500 Forecasts{% endblock %}
{% block content %}
  {% if error %}
    <div class="mb-4 rounded-md border border-red-500/30 bg-red-500/10 px-4 py-2 text-sm">{{ error }}</div>
  {% endif %}

  <div class="grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
    <div class="rounded-xl border border-gray-200 bg-white p-5 shadow-sm dark:border-gray-800 dark:bg-gray-900">
      <div class="text-3xl font-semibold">{{ total_forecasts }}</div>
      <div class="text-sm text-gray-500 dark:text-gray-400">Total Forecasts</div>
    </div>
    <div class="rounded-xl border border-gray-200 bg-white p-5 shadow-sm dark:border-gray-800 dark:bg-gray-900">
      <div class="text-3xl font-semibold">{{ last_updated_count }}</div>
      <div class="text-sm text-gray-500 dark:text-gray-400">Updated Today</div>
    </div>
    <div class="rounded-xl border border-gray-200 bg-white p-5 shadow-sm dark:border-gray-800 dark:bg-gray-900">
      <div class="text-3xl font-semibold">{{ avg_prediction_change|round(2) }}%</div>
      <div class="text-sm text-gray-500 dark:text-gray-400">Avg Prediction Change</div>
    </div>
  </div>

  <div class="mt-4 rounded-xl border border-gray-200 bg-white p-5 shadow-sm dark:border-gray-800 dark:bg-gray-900">
    <div class="flex flex-wrap items-center gap-3">
      <input id="searchInput" class="flex-1 min-w-[220px] rounded-md border border-gray-200 bg-white px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-indigo-500 dark:border-gray-800 dark:bg-gray-900" placeholder="Enter ticker symbol (e.g., AAPL, MSFT, GOOGL)" />
      <button onclick="searchStocks()" class="rounded-md bg-indigo-600 px-3 py-2 text-sm font-medium text-white hover:bg-indigo-500">Search</button>
    </div>
    <div class="mt-2 text-xs text-gray-500 dark:text-gray-400">Enter a ticker symbol to filter the forecasts. Leave empty to show all.</div>
  </div>

  {% if forecasts %}
  <div id="forecastsGrid" class="mt-4 grid items-stretch gap-4 sm:grid-cols-2 lg:grid-cols-3">
    {% for ticker, forecast in forecasts.items() %}
      {% set change = ( (forecast.next_day_prediction - forecast.current_price) / forecast.current_price * 100 ) if (forecast.next_day_prediction and forecast.current_price) else None %}
      <div data-ticker="{{ ticker }}" class="h-full rounded-xl border border-gray-200 bg-white p-5 shadow-sm dark:border-gray-800 dark:bg-gray-900 flex flex-col">
        <div class="flex items-center justify-between">
          <h3 class="font-semibold">{{ ticker }}</h3>
          {% if change is not none %}
            <span class="px-2 py-0.5 rounded-full text-xs font-semibold
              {% if change > 0 %} bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-300
              {% elif change < 0 %} bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-300
              {% else %} bg-gray-100 text-gray-700 dark:bg-gray-800 dark:text-gray-300{% endif %}">
              {{ "%.2f"|format(change) }}%
            </span>
          {% endif %}
        </div>
        <div class="mt-3 space-y-1 text-sm">
          {% if forecast.next_day_prediction %}<div>Next Day: ${{ "%.2f"|format(forecast.next_day_prediction) }}</div>{% endif %}
          {% if forecast.current_price %}<div>Current: ${{ "%.2f"|format(forecast.current_price) }}</div>{% endif %}
          {% if forecast.last_updated %}<div class="text-gray-500 dark:text-gray-400 text-xs">Updated: {{ forecast.last_updated }}</div>{% endif %}
        </div>
        <div class="mt-auto"></div>
      </div>
    {% endfor %}
  </div>
  {% else %}
  <div class="mt-4 rounded-xl border border-gray-200 bg-white p-5 text-sm shadow-sm dark:border-gray-800 dark:bg-gray-900">
    <h3 class="text-base font-medium">Loading forecasts...</h3>
    <p class="text-gray-600 dark:text-gray-300">This may take a few moments as we prepare the latest S&P 500 forecasts.</p>
  </div>
  {% endif %}

  {% if last_update %}
  <div class="mt-4 text-center text-sm text-gray-500 dark:text-gray-400">Last system update: {{ last_update }}</div>
  {% endif %}
{% endblock %}

{% block scripts %}
<script>
  function searchStocks() {
    const input = document.getElementById('searchInput');
    const searchTerm = (input?.value || '').toUpperCase();
    const cards = document.querySelectorAll('[data-ticker]');
    cards.forEach(card => {
      const t = card.getAttribute('data-ticker');
      card.style.display = (!searchTerm || t.includes(searchTerm)) ? 'block' : 'none';
    });
  }
  document.getElementById('searchInput')?.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') searchStocks();
  });
  setInterval(() => location.reload(), 300000);
</script>
{% endblock %}
